import EnhancedCombinedSimulation from "@/components/simulations/EnhancedCombinedSimulation";
import { CellularAutomaton } from "@/components/simulations/CellularAutomaton";
import { useState, useRef, useEffect } from "react";

const Index = () => {
  const [showInfo, setShowInfo] = useState(true);
  const [showExplanation, setShowExplanation] = useState(false);
  const [simulationKey, setSimulationKey] = useState(0);
  const [simulationMode, setSimulationMode] = useState<'enhanced'|'species'>('enhanced');
  const [isMuted, setIsMuted] = useState(false);
  const [audioInitialized, setAudioInitialized] = useState(false);
  
  const audioRef = useRef<HTMLAudioElement | null>(null);

  const resetSimulation = () => {
    setSimulationKey(prev => prev + 1);
  };

  // Funci√≥n para inicializar audio de manera agresiva
  const forceInitializeAudio = async () => {
    if (audioRef.current && !audioInitialized) {
      try {
        audioRef.current.volume = isMuted ? 0 : 0.3;
        audioRef.current.muted = false;
        await audioRef.current.play();
        setAudioInitialized(true);
        console.log("‚úÖ Audio inicializado exitosamente");
      } catch (error) {
        console.log("‚ùå Error al inicializar audio:", error);
      }
    }
  };

  const toggleMute = () => {
    if (audioRef.current) {
      if (isMuted) {
        // Reactivar audio
        audioRef.current.volume = 0.3;
        if (audioRef.current.paused) {
          audioRef.current.play().catch(() => {
            console.log("Error al reproducir audio");
          });
        }
      } else {
        // Silenciar audio (pero no pausar)
        audioRef.current.volume = 0;
      }
      setIsMuted(!isMuted);
    }
  };

  // Efecto para manejar el audio al montar el componente - SOLO PREPARAR, NO REPRODUCIR
  useEffect(() => {
    const initializeAudio = async () => {
      if (audioRef.current) {
        console.log("üéµ Preparando audio para despu√©s del Big Bang...");
        
        // Configuraci√≥n inicial - SIN reproducir autom√°ticamente
        audioRef.current.volume = isMuted ? 0 : 0.3;
        audioRef.current.loop = true;
        audioRef.current.autoplay = false; // NO autoplay - esperar evento
        
        // Solo preparar el audio, no reproducir
        try {
          audioRef.current.load(); // Precargar el audio
          console.log("‚úÖ Audio precargado, esperando Big Bang");
        } catch (error) {
          console.log("‚ùå Error precargando audio:", error);
        }
      }
    };

    // Solo preparar una vez
    initializeAudio();
  }, [simulationKey]);

  // Efecto separado para manejar cambios de mute
  useEffect(() => {
    if (audioRef.current) {
      audioRef.current.volume = 0.3
    }

    // üéµ ESCUCHAR EVENTO PARA INICIAR M√öSICA DESPU√âS DEL BIG BANG
    const handleStartMusic = async () => {
      if (audioRef.current && !isMuted) {
        try {
          audioRef.current.currentTime = 0
          await audioRef.current.play()
          setAudioInitialized(true)
          console.log('üéµ M√∫sica de fondo iniciada despu√©s del Big Bang')
        } catch (error) {
          console.log('Error iniciando m√∫sica:', error)
        }
      }
    }

    window.addEventListener('startBackgroundMusic', handleStartMusic)
    
    return () => {
      window.removeEventListener('startBackgroundMusic', handleStartMusic)
    }
  }, [isMuted])

  return (
    <div className="cosmic-canvas w-screen h-screen overflow-hidden relative bg-black">
      {/* TU ANIMACI√ìN DORADA INTOCABLE - BACKGROUND COMPLETO */}
      <div className="absolute inset-0 z-0">
        {simulationMode === 'enhanced' ? (
          <EnhancedCombinedSimulation key={`enhanced-${simulationKey}`} />
        ) : (
          <CellularAutomaton key={`species-${simulationKey}`} />
        )}
      </div>

      {/* OVERLAY PROFESIONAL - NO INTERFIERE CON LA ANIMACI√ìN */}
      <div className="absolute inset-0 z-10 pointer-events-none">
        
        {/* HEADER DISCRETO */}
        <div className="absolute top-6 left-6 pointer-events-auto flex space-x-3">
          <button 
            onClick={() => setShowInfo(!showInfo)}
            className="px-4 py-2 bg-black/30 backdrop-blur-sm border border-amber-500/20 
                       text-amber-300 text-sm font-mono rounded-md hover:bg-black/50 
                       transition-all duration-300 hover:border-amber-400/40"
          >
            {showInfo ? '‚óâ INFO' : '‚óã INFO'}
          </button>
          
          <button 
            onClick={() => setShowExplanation(!showExplanation)}
            className="px-4 py-2 bg-black/30 backdrop-blur-sm border border-amber-500/20 
                       text-amber-300 text-sm font-mono rounded-md hover:bg-black/50 
                       transition-all duration-300 hover:border-amber-400/40"
          >
            {showExplanation ? '‚óâ ¬øQU√â VES?' : '‚óã ¬øQU√â VES?'}
          </button>

        
        </div>

        {/* INFORMACI√ìN PROFESIONAL - OVERLAY ELEGANTE */}
        {showInfo && (
          <div className="absolute top-6 right-6 max-w-md pointer-events-auto
                          bg-black/40 backdrop-blur-lg border border-amber-500/20 
                          rounded-lg p-6 shadow-2xl">
            
            {/* GLOW EFFECT MATCHING YOUR ANIMATION */}
            <div className="absolute inset-0 bg-gradient-to-br from-amber-500/5 to-orange-500/5 
                            rounded-lg blur-xl"></div>
            
            <div className="relative z-10">
              {/* NOMBRE PRINCIPAL */}
              <h1 className="text-2xl font-bold text-amber-300 mb-2 
                             drop-shadow-lg font-mono tracking-wide">
                Francisco Emmanuel
                <br />
                <span className="text-amber-400">Arias L√≥pez</span>
              </h1>
              
              {/* T√çTULO PROFESIONAL */}
              <div className="mb-4 space-y-1">
                <p className="text-amber-200 font-semibold text-lg">
                  Licenciado en Multimedia
                </p>
                <p className="text-amber-200 font-semibold">
                  y Animaci√≥n Digital
                </p>
              </div>
              
              {/* INSTITUCI√ìN */}
              <div className="mb-6 pb-4 border-b border-amber-500/20">
                <p className="text-amber-300/80 text-sm font-mono">
                  Facultad de Ciencias
                  <br />
                  F√≠sico Matem√°ticas
                </p>
              </div>
              
              {/* DESCRIPCI√ìN T√âCNICA */}
              <div className="space-y-2 text-xs text-amber-200/70 font-mono">
                <p>üß¨ Conway's Game of Life</p>
                <p>üåå Lorenz Attractor System</p>
                <p>‚ö° Real-time Particle Physics</p>
                <p>üé® Procedural Color Synthesis</p>
              </div>
            </div>
          </div>
        )}

        {/* PANEL EDUCATIVO - EXPLICACI√ìN PARA VISITANTES */}
        {showExplanation && (
          <div className="absolute top-6 left-1/2 transform -translate-x-1/2 max-w-4xl pointer-events-auto
                          bg-black/50 backdrop-blur-lg border border-amber-500/25 
                          rounded-lg p-8 shadow-2xl max-h-[80vh] overflow-y-auto">
            
            {/* GLOW EFFECT */}
            <div className="absolute inset-0 bg-gradient-to-br from-amber-500/8 to-orange-500/8 
                            rounded-lg blur-xl"></div>
            
            <div className="relative z-10">
              {/* T√çTULO PRINCIPAL */}
              <h1 className="text-3xl font-bold text-amber-300 mb-6 text-center
                             drop-shadow-lg font-mono tracking-wide">
                üåå ¬øQu√© est√°s viendo? üåå
              </h1>
              
              <div className="space-y-6 text-amber-200">
                
                {/* CONWAY'S GAME OF LIFE */}
                <div className="bg-black/20 rounded-lg p-4 border border-amber-500/10">
                  <h2 className="text-xl font-bold text-amber-300 mb-3 flex items-center">
                    üß¨ El Juego de la Vida de Conway
                  </h2>
                  <div className="space-y-2 text-sm">
                    <p><strong className="text-amber-400">¬øQu√© es?</strong> El Juego de la Vida de Conway (Conway's Game of Life) es un aut√≥mata celular creado por el matem√°tico brit√°nico John Horton Conway en 1970. A pesar de su nombre, no es un juego en el sentido tradicional, sino una simulaci√≥n matem√°tica que ilustra c√≥mo comportamientos complejos pueden emerger de reglas simples aplicadas a sistemas distribuidos.</p>
                    <p><strong className="text-amber-400">¬øC√≥mo funciona?</strong>El universo del Juego de la Vida es una rejilla bidimensional (matriz) compuesta por celdas, cada una de las cuales puede estar en uno de dos estados:

Viva (1)

Muerta (0)

Cada celda interact√∫a con sus 8 vecinas adyacentes (horizontal, vertical y diagonal). En cada iteraci√≥n, el estado de todas las celdas se actualiza simult√°neamente seg√∫n estas reglas simples:</p>
                    <p><strong className="text-amber-400">‚öôÔ∏è Reglas del juego</strong> Supervivencia:
Una c√©lula viva con 2 o 3 vecinas vivas sobrevive.

Muerte por soledad:
Una c√©lula viva con menos de 2 vecinas vivas muere.

Muerte por sobrepoblaci√≥n:
Una c√©lula viva con m√°s de 3 vecinas vivas muere.

Nacimiento:
Una c√©lula muerta con exactamente 3 vecinas vivas revive.

</p>
                    <p><strong className="text-amber-400">¬øPor qu√© es fascinante?</strong> El Juego de la Vida de Conway es fascinante porque demuestra c√≥mo reglas extremadamente simples pueden generar comportamientos incre√≠blemente complejos y sorprendentes</p>
                  </div>
                </div>

                {/* LORENZ ATTRACTOR */}
                <div className="bg-black/20 rounded-lg p-4 border border-amber-500/10">
                  <h2 className="text-xl font-bold text-amber-300 mb-3 flex items-center">
                    üåå Sistema de Atractor de Lorenz
                  </h2>
                  <div className="space-y-2 text-sm">
                    <p><strong className="text-amber-400">¬øQu√© es?</strong> Es un conjunto de ecuaciones diferenciales no lineales que modelan el comportamiento ca√≥tico de ciertos sistemas din√°micos, como la atm√≥sfera. Fue formulado por Edward Lorenz en 1963 y se convirti√≥ en uno de los primeros ejemplos del caos determinista.</p>
                    <p><strong className="text-amber-400">En esta animaci√≥n:</strong> el Atractor de Lorenz puede representarse como una hermosa animaci√≥n espiral tridimensional, pero no es una espiral simple o regular:
es una espiral doble ca√≥tica, donde las trayectorias giran alrededor de dos l√≥bulos de forma aparentemente ordenada, pero nunca se repiten ni se cierran.</p>
<p><strong className="text-amber-400">üìä Las matem√°ticas:</strong> El Sistema de Lorenz se basa en tres ecuaciones diferenciales no lineales que crean patrones infinitos.
ùëëùë•/ùëëùë° =ùúé(ùë¶‚àíùë•),  ùëëùë¶/ùëëùë° =ùë•(ùúå‚àíùëß)‚àíùë¶, ùëëùëß/ùëëùë° =ùë•ùë¶‚àíŒ≤ùëß</p>
                    <p><strong className="text-amber-400">¬øPor qu√© es hermoso?</strong> es hermoso porque combina caos y orden en una estructura fluida y sim√©trica. Su forma, parecida a unas alas de mariposa, revela una danza infinita de trayectorias que nunca se cruzan, pero tampoco escapan ni se repiten.</p>
                  </div>
                </div>

                {/* PARTICLE PHYSICS */}
                <div className="bg-black/20 rounded-lg p-4 border border-amber-500/10">
                  <h2 className="text-xl font-bold text-amber-300 mb-3 flex items-center">
                    ‚ö° F√≠sica de Part√≠culas en Tiempo Real
                  </h2>
                  <div className="space-y-2 text-sm">
                    <p><strong className="text-amber-400">¬øQu√© son?</strong> Las peque√±as luces que emergen de las c√©lulas vivas y viajan hacia el atractor. Representa una simulaci√≥n visual y algor√≠tmica en la que part√≠culas virtuales ‚Äîcomo c√©lulas, nodos energ√©ticos o trayectorias del atractor de Lorenz‚Äî evolucionan din√°micamente seg√∫n principios f√≠sicos simplificados, renderizadas en animaciones sincronizadas con frecuencia, energ√≠a y pulsos c√≥smicos.</p>
                    <p><strong className="text-amber-400">üì°En esta animaci√≥n:</strong> Son entidades visuales din√°micas que emulan materia y energ√≠a en evoluci√≥n, modeladas con l√≥gica de sistemas complejos, aut√≥matas celulares y atractores ca√≥ticos. Una especie de ‚Äúmicrof√≠sica visual simbi√≥tica‚Äù generada en tiempo real.</p>

                    <p><strong className="text-amber-400">El efecto:</strong> Ambos sistemas parecen "hablar" entre s√≠, creando una sinfon√≠a visual</p>
                  </div>
                </div>

                {/* PROCEDURAL COLORS */}
                <div className="bg-black/20 rounded-lg p-4 border border-amber-500/10">
                  <h2 className="text-xl font-bold text-amber-300 mb-3 flex items-center">
                    üé® S√≠ntesis de Color Procedimental
                  </h2>
                  <div className="space-y-2 text-sm">
                    <p><strong className="text-amber-400">¬øQu√© significa?</strong> Significa crear colores autom√°ticamente mediante algoritmos, usando f√≥rmulas en lugar de elegir colores manualmente.</p>
                    <p><strong className="text-amber-400">ü™Ñ En esta animaci√≥n:</strong> Ocurre una coreograf√≠a c√≥smica algor√≠tmica, donde m√∫ltiples sistemas interact√∫an simult√°neamente en una danza de l√≥gica, caos y energ√≠a visual.</p>

                    <p><strong className="text-amber-400">El resultado:</strong> Una paleta que evoluciona org√°nicamente con el comportamiento del sistema</p>
                  </div>
                </div>

               

              </div>
              
              {/* MENSAJE FINAL */}
              <div className="mt-6 p-4 bg-amber-500/10 rounded-lg border border-amber-500/20">
                <p className="text-center text-amber-300 text-sm font-mono">
                  ‚ú® Esta es una demostraci√≥n de c√≥mo las matem√°ticas pueden crear belleza ‚ú®
                  <br />
                  <span className="text-amber-400">Cada frame es calculado en tiempo real - ¬°No hay videos ni animaciones pregrabadas!</span>
                </p>
              </div>
            </div>
          </div>
        )}

        {/* FOOTER T√âCNICO */}
        <div className="absolute bottom-6 left-6 pointer-events-auto">
          <div className="flex space-x-4 text-xs font-mono text-amber-400/60">
            <span>React + TypeScript</span>
            <span>‚Ä¢</span>
            <span>HTML5 Canvas</span>
            <span>‚Ä¢</span>
            <span>Mathematical Modeling</span>
          </div>
        </div>

        {/* CONTROLES - REINICIO Y AUDIO */}
        <div className="absolute bottom-6 right-6 pointer-events-auto flex space-x-3">
          <button 
            onClick={toggleMute}
            className="w-12 h-12 bg-black/30 backdrop-blur-sm border border-amber-500/20 
                       text-amber-300 rounded-full hover:bg-black/50 transition-all duration-300 
                       flex items-center justify-center text-lg hover:scale-110 hover:border-amber-400/40
                       hover:text-amber-200"
            title={isMuted ? "Activar Audio" : "Silenciar Audio"}
          >
            {isMuted ? 'üîá' : 'üîä'}
          </button>
          
          <button 
            onClick={resetSimulation}
            className="w-12 h-12 bg-black/30 backdrop-blur-sm border border-amber-500/20 
                       text-amber-300 rounded-full hover:bg-black/50 transition-all duration-300 
                       flex items-center justify-center text-lg hover:scale-110 hover:border-amber-400/40
                       hover:text-amber-200"
            title="Reiniciar Simulaci√≥n"
          >
            ‚ü≤
          </button>
        </div>

        {simulationMode === 'species' && (
          <div className="absolute bottom-6 left-1/2 -translate-x-1/2 pointer-events-auto bg-black/40 backdrop-blur-md border border-amber-500/20 rounded-lg px-5 py-3 flex flex-wrap gap-3 max-w-xl justify-center text-[10px] font-mono text-amber-200">
            <div className="flex items-center gap-1"><span className="w-3 h-3 rounded-sm" style={{background:'hsl(0,90%,60%)'}}></span>Especie 1</div>
            <div className="flex items-center gap-1"><span className="w-3 h-3 rounded-sm" style={{background:'hsl(60,90%,60%)'}}></span>Especie 2</div>
            <div className="flex items-center gap-1"><span className="w-3 h-3 rounded-sm" style={{background:'hsl(120,70%,55%)'}}></span>Especie 3</div>
            <div className="flex items-center gap-1"><span className="w-3 h-3 rounded-sm" style={{background:'hsl(180,70%,55%)'}}></span>Especie 4</div>
            <div className="flex items-center gap-1"><span className="w-3 h-3 rounded-sm" style={{background:'hsl(240,70%,60%)'}}></span>Especie 5</div>
            <div className="flex items-center gap-1"><span className="w-3 h-3 rounded-sm" style={{background:'hsl(300,70%,60%)'}}></span>Especie 6</div>
            <div className="flex items-center gap-1"><span className="w-3 h-3 rounded-sm" style={{background:'hsl(30,85%,60%)'}}></span>Especie 7</div>
            <div className="flex items-center gap-1"><span className="w-3 h-3 rounded-sm border border-white/40" style={{background:'hsl(270,70%,60%)'}}></span>Reserva</div>
            <div className="opacity-70">Armas: gris=f√°brica, rojo=arma, amarillo=cabeza nuclear</div>
          </div>
        )}
        
        {/* ELEMENTO DE AUDIO PARA M√öSICA DE FONDO */}
                <audio
          ref={audioRef}
          loop
          preload="auto"
          muted={isMuted}
          onCanPlayThrough={() => {
            console.log("Audio listo para reproducir - esperando Big Bang");
          }}
          onLoadedData={() => {
            // Configuraci√≥n para loop seamless
            if (audioRef.current) {
              // Detectar casi el final del audio y hacer loop manual
              audioRef.current.addEventListener('timeupdate', () => {
                if (audioRef.current) {
                  // Loop cuando quedan 30ms para terminar
                  if (audioRef.current.currentTime >= audioRef.current.duration - 0.03) {
                    audioRef.current.currentTime = 0.01; // Peque√±o offset para evitar clicks
                  }
                }
              });
            }
          }}
          onPlay={() => {
            console.log("üéµ M√∫sica de fondo iniciada despu√©s del Big Bang");
            setAudioInitialized(true);
          }}
          onPause={() => {
            console.log("Audio pausado");
          }}
          onError={(e) => {
            console.log("Error cargando audio:", e);
          }}
        >
          <source src="/FREQUENCY.mp3" type="audio/mpeg" />
          Tu navegador no soporta audio HTML5.
        </audio>
      </div>
    </div>
  );
};

export default Index;